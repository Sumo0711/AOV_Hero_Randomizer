<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AOV 隨機生成器</title>
<style>
body { font-family: "Microsoft JhengHei", sans-serif; background-color: #1b1b1b; color: #fff; text-align: center; padding: 20px; }
h1 { font-size: 2rem; margin-bottom: 20px; }
h2 { font-size: 1.5rem; margin: 20px 0 10px; }
button { background-color: #4CAF50; color: white; border: none; padding: 8px 16px; margin: 10px 0; border-radius: 6px; cursor: pointer; font-size: 1rem; }
button:hover { background-color: #45a049; }
.result { margin-top: 10px; font-size: 1.2rem; background: #222; padding: 10px; border-radius: 8px; display: inline-block; }
.checkbox-list { display: flex; flex-wrap: wrap; justify-content: center; max-width: 600px; margin: 10px auto; background: #2a2a2a; padding: 8px; border-radius: 10px; }
label { margin: 4px 10px; display: flex; align-items: center; }
select { background: #2a2a2a; color: #fff; border: 1px solid #555; border-radius: 6px; padding: 6px; margin-top: 8px; min-width: 200px; }
@media (min-width: 768px) { select { display: none; } }
@media (max-width: 767px) { .checkbox-list { display: none; } }
</style>
</head>
<body>

<h1>AOV 隨機生成器</h1>

<!-- 分路 -->
<div class="section" id="laneSection">
  <h2>分路</h2>
  <div class="checkbox-list" id="laneList"></div>
  <select id="laneSelect" multiple></select><br>
  <button id="drawLaneBtn" onclick="drawLane()">隨機分路</button>
  <div class="result" id="laneResult">還沒抽取</div>
</div>

<!-- 英雄 -->
<div class="section" id="heroSection">
  <h2>英雄</h2>
  <div class="checkbox-list" id="heroList"></div>
  <select id="heroSelect" multiple></select><br>
  <button onclick="drawHero()">隨機英雄</button>
  <div class="result" id="heroResult">還沒抽取</div>
</div>

<!-- 技能 -->
<div class="section" id="skillSection">
  <h2>挑戰者技能</h2>
  <div class="checkbox-list" id="skillList"></div>
  <select id="skillSelect" multiple></select><br>
  <button onclick="drawSkill()">隨機技能</button>
  <div class="result" id="skillResult">還沒抽取</div>
</div>

<script>
let heroes = [], skills = [], lanes = [];

/* ==========================================================
   讀取資料
========================================================== */
async function loadData() {
  try {
    const response = await fetch('DB.json');
    const data = await response.json();
    heroes = data.heroes;
    skills = data.skills;

    const laneSet = new Set();
    heroes.forEach(h => h.lane.forEach(l => laneSet.add(l)));
    lanes = Array.from(laneSet);

    renderLaneCheckbox();
    renderCheckboxWithAll('hero', heroes.map(h => h.name));
    renderCheckboxWithAll('skill', skills);

    populateSelect('laneSelect', ['全選', ...lanes, '全能'], ['全選']);
    populateSelect('heroSelect', heroes.map(h => h.name));
    populateSelect('skillSelect', skills);

    filterHeroesByLane();

  } catch (err) {
    console.error(err);
    alert("資料載入失敗");
  }
}

/* ==========================================================
   渲染 checkbox
========================================================== */
function renderLaneCheckbox() {
  const container = document.getElementById('laneList');
  container.innerHTML = '';
  const drawBtn = document.getElementById('drawLaneBtn');

  // 全選
  const allLabel = document.createElement('label');
  allLabel.innerHTML = `<input type="checkbox" id="laneSelectAll" checked> 全選`;
  container.appendChild(allLabel);

  allLabel.querySelector('input').addEventListener('change', function () {
    container.querySelectorAll('input.itemCheckbox').forEach(cb => {
      cb.checked = this.checked;
      cb.disabled = false;
    });
    document.getElementById('laneAllPower').checked = false;
    drawBtn.disabled = false;
    filterHeroesByLane();
    syncDesktopLaneToMobile();
  });

  // 分路
  lanes.forEach(lane => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" class="itemCheckbox" value="${lane}" checked> ${lane}`;
    container.appendChild(label);

    label.querySelector('input').addEventListener('change', function () {
      document.getElementById('laneSelectAll').checked = false;
      document.getElementById('laneAllPower').checked = false;
      filterHeroesByLane();
      syncDesktopLaneToMobile();
    });
  });

  // 全能
  const allPowerLabel = document.createElement('label');
  allPowerLabel.innerHTML = `<input type="checkbox" id="laneAllPower"> 全能`;
  container.appendChild(allPowerLabel);

  allPowerLabel.querySelector('input').addEventListener('change', function () {
    const cbs = container.querySelectorAll('input.itemCheckbox');
    if (this.checked) {
      cbs.forEach(cb => { cb.checked = false; cb.disabled = true; });
      document.getElementById('laneSelectAll').checked = false;
      drawBtn.disabled = true;
      showAllHeroes();
    } else {
      cbs.forEach(cb => cb.disabled = false);
      drawBtn.disabled = false;
      filterHeroesByLane();
    }
    syncDesktopLaneToMobile();
  });
}

/* ==========================================================
   checkbox 通用 renderer
========================================================== */
function renderCheckboxWithAll(type, items) {
  const container = document.getElementById(type + 'List');
  container.innerHTML = '';
  items.forEach(item => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" class="itemCheckbox" value="${item}" checked> ${item}`;
    container.appendChild(label);

    label.querySelector('input').addEventListener('change', syncDesktopHeroSkillToMobile);
  });
}

/* ==========================================================
   select renderer（手機 UI）
========================================================== */
function populateSelect(id, items, preSelect = []) {
  const select = document.getElementById(id);
  select.innerHTML = '';

  items.forEach(item => {
    const op = document.createElement('option');
    op.value = item;
    op.textContent = item;
    if (preSelect.includes(item)) op.selected = true;
    select.appendChild(op);
  });

  // select → checkbox 同步
  if (id === 'laneSelect') select.addEventListener('change', syncMobileLaneToDesktop);
  if (id === 'heroSelect') select.addEventListener('change', syncMobileHeroToDesktop);
  if (id === 'skillSelect') select.addEventListener('change', syncMobileSkillToDesktop);
}

/* ==========================================================
   unify select / checkbox
========================================================== */
function getCheckedItems(type) {
  if (window.innerWidth >= 768) {
    return Array.from(document.querySelectorAll(`#${type}List input.itemCheckbox:checked`))
      .map(cb => cb.value);
  } else {
    return Array.from(document.getElementById(type + 'Select').selectedOptions)
      .map(o => o.value);
  }
}

/* ==========================================================
   select → checkbox（手機同步桌機）
========================================================== */
function getMobileSelected(id) {
  return Array.from(document.getElementById(id).selectedOptions).map(o => o.value);
}

function syncMobileLaneToDesktop() {
  const selected = getMobileSelected('laneSelect');
  const cbs = document.querySelectorAll('#laneList input.itemCheckbox');
  const allSelect = document.getElementById('laneSelectAll');
  const allPower = document.getElementById('laneAllPower');

  cbs.forEach(cb => { cb.checked = false; cb.disabled = false; });
  allSelect.checked = false;
  allPower.checked = false;

  if (selected.includes('全能')) {
    allPower.checked = true;
    cbs.forEach(cb => { cb.checked = false; cb.disabled = true; });
    filterHeroesByLane(['全能']);
    return syncDesktopLaneToMobile();
  }

  if (selected.includes('全選')) {
    allSelect.checked = true;
    cbs.forEach(cb => cb.checked = true);
    filterHeroesByLane(lanes);
    return syncDesktopLaneToMobile();
  }

  selected.forEach(v => {
    const target = [...cbs].find(cb => cb.value === v);
    if (target) target.checked = true;
  });

  filterHeroesByLane(selected);
  syncDesktopLaneToMobile();
}

function syncMobileHeroToDesktop() {
  const selected = getMobileSelected('heroSelect');
  document.querySelectorAll('#heroList input.itemCheckbox').forEach(cb => {
    cb.checked = selected.includes(cb.value);
  });
}

function syncMobileSkillToDesktop() {
  const selected = getMobileSelected('skillSelect');
  document.querySelectorAll('#skillList input.itemCheckbox').forEach(cb => {
    cb.checked = selected.includes(cb.value);
  });
}

/* ==========================================================
   checkbox → select（桌機同步手機）
========================================================== */
function syncDesktopLaneToMobile() {
  const select = document.getElementById('laneSelect');
  const allSelect = document.getElementById('laneSelectAll');
  const allPower = document.getElementById('laneAllPower');

  const values = [];

  if (allPower.checked) values.push('全能');
  else if (allSelect.checked) values.push('全選');
  else {
    document.querySelectorAll('#laneList input.itemCheckbox:checked')
      .forEach(cb => values.push(cb.value));
  }

  [...select.options].forEach(op => {
    op.selected = values.includes(op.value);
  });
}

function syncDesktopHeroSkillToMobile() {
  const heroSelect = document.getElementById('heroSelect');
  const heroCbs = document.querySelectorAll('#heroList input.itemCheckbox');

  [...heroSelect.options].forEach(op => {
    const match = [...heroCbs].find(cb => cb.value === op.value);
    op.selected = match && match.checked;
  });

  const skillSelect = document.getElementById('skillSelect');
  const skillCbs = document.querySelectorAll('#skillList input.itemCheckbox');

  [...skillSelect.options].forEach(op => {
    const match = [...skillCbs].find(cb => cb.value === op.value);
    op.selected = match && match.checked;
  });
}

/* ==========================================================
   英雄篩選
========================================================== */
function filterHeroesByLane(selectedLanes) {
  selectedLanes = selectedLanes || getCheckedItems('lane');

  const heroContainer = document.getElementById('heroList');

  if (selectedLanes.includes('全能') || selectedLanes.includes('全選')) {
    showAllHeroes();
    return;
  }

  heroContainer.querySelectorAll('input.itemCheckbox').forEach(cb => {
    const hero = heroes.find(h => h.name === cb.value);
    const ok = hero.lane.some(l => selectedLanes.includes(l));

    cb.parentElement.style.display = ok ? 'flex' : 'none';
    cb.checked = ok;
  });

  syncDesktopHeroSkillToMobile();
}

function showAllHeroes() {
  document.querySelectorAll('#heroList input.itemCheckbox').forEach(cb => {
    cb.parentElement.style.display = 'flex';
    cb.checked = true;
  });
  syncDesktopHeroSkillToMobile();
}

/* ==========================================================
   抽選功能（電腦與手機共用）
========================================================== */
function getRandomItem(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function drawLane() {
  const selected = getCheckedItems('lane').filter(l => l !== '全能' && l !== '全選');
  if (selected.length === 0) {
    alert("⚠️ 請至少勾選一個分路！");
    return;
  }
  const lane = getRandomItem(selected);
  document.getElementById('laneResult').textContent = lane;
  filterHeroesByLane([lane]);
}

function drawHero() {
  const visible = [...document.querySelectorAll('#heroList input.itemCheckbox')]
    .filter(cb => cb.parentElement.style.display !== 'none')
    .map(cb => cb.value);

  if (visible.length === 0) {
    alert("⚠️ 沒有可抽英雄！");
    return;
  }

  document.getElementById('heroResult').textContent = getRandomItem(visible);
}

function drawSkill() {
  const selected = getCheckedItems('skill');
  if (selected.length === 0) {
    alert("⚠️ 請至少勾選一個技能！");
    return;
  }
  document.getElementById('skillResult').textContent = getRandomItem(selected);
}

loadData();
</script>

</body>
</html>