<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AOV 隨機生成器</title>
<style>
body { font-family: "Microsoft JhengHei", sans-serif; background-color: #1b1b1b; color: #fff; text-align: center; padding: 20px; }
h1 { font-size: 2rem; margin-bottom: 20px; }
h2 { font-size: 1.5rem; margin: 20px 0 10px; }
button { background-color: #4CAF50; color: white; border: none; padding: 8px 16px; margin: 10px 0; border-radius: 6px; cursor: pointer; font-size: 1rem; }
button:hover { background-color: #45a049; }
.result { margin-top: 10px; font-size: 1.2rem; background: #222; padding: 10px; border-radius: 8px; display: inline-block; }
.checkbox-list { display: flex; flex-wrap: wrap; justify-content: center; max-width: 600px; margin: 10px auto; background: #2a2a2a; padding: 8px; border-radius: 10px; }
label { margin: 4px 10px; display: flex; align-items: center; }
select { background: #2a2a2a; color: #fff; border: 1px solid #555; border-radius: 6px; padding: 6px; margin-top: 8px; min-width: 200px; }
@media (min-width: 768px) { select { display: none; } }
@media (max-width: 767px) { .checkbox-list { display: none; } }
</style>
</head>
<body>

<h1>AOV 隨機生成器</h1>

<!-- 分路 -->
<div class="section" id="laneSection">
  <h2>分路</h2>
  <div class="checkbox-list" id="laneList"></div>
  <select id="laneSelect" multiple></select><br>
  <button id="drawLaneBtn" onclick="drawLane()">隨機分路</button>
  <div class="result" id="laneResult">還沒抽取</div>
</div>

<!-- 英雄 -->
<div class="section" id="heroSection">
  <h2>英雄</h2>
  <div class="checkbox-list" id="heroList"></div>
  <select id="heroSelect" multiple></select><br>
  <button onclick="drawHero()">隨機英雄</button>
  <div class="result" id="heroResult">還沒抽取</div>
</div>

<!-- 技能 -->
<div class="section" id="skillSection">
  <h2>挑戰者技能</h2>
  <div class="checkbox-list" id="skillList"></div>
  <select id="skillSelect" multiple></select><br>
  <button onclick="drawSkill()">隨機技能</button>
  <div class="result" id="skillResult">還沒抽取</div>
</div>

<script>
let heroes = [], skills = [], lanes = [];

/* ==========================================================
   讀取資料
========================================================== */
async function loadData() {
  try {
    const response = await fetch('DB.json');
    const data = await response.json();
    heroes = data.heroes;
    skills = data.skills;

    lanes = [...new Set(heroes.flatMap(h => h.lane))];

    renderLaneCheckbox();
    renderCheckboxWithAll('hero', heroes.map(h => h.name));
    renderCheckboxWithAll('skill', skills);

    populateSelect('laneSelect', ['全選', ...lanes], ['全選']);
    populateSelect('heroSelect', heroes.map(h => h.name));
    populateSelect('skillSelect', skills);

    syncDesktopHeroSkillToMobile();

  } catch (err) {
    alert("資料載入失敗");
  }
}

/* ==========================================================
   checkbox：分路
========================================================== */
function renderLaneCheckbox() {
  const container = document.getElementById('laneList');
  container.innerHTML = '';

  // 全選
  const allLabel = document.createElement('label');
  allLabel.innerHTML = `<input type="checkbox" id="laneSelectAll" checked> 全選`;
  container.appendChild(allLabel);

  allLabel.querySelector('input').addEventListener('change', function () {
    const cbs = container.querySelectorAll('input.itemCheckbox');
    cbs.forEach(cb => cb.checked = this.checked);

    if (this.checked) {
      showAllHeroes(); // ← 全選 = 所有英雄都先選起來
    }

    syncDesktopLaneToMobile();
    syncDesktopHeroSkillToMobile();
  });

  // 分路列表
  lanes.forEach(lane => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" class="itemCheckbox" value="${lane}" checked> ${lane}`;
    container.appendChild(label);

    label.querySelector('input').addEventListener('change', function () {

      // 若有任一取消，全選要取消
      document.getElementById('laneSelectAll').checked = false;

      syncDesktopLaneToMobile();
    });
  });
}

/* ==========================================================
   checkbox：英雄 & 技能
========================================================== */
function renderCheckboxWithAll(type, items) {
  const container = document.getElementById(type + 'List');
  container.innerHTML = '';

  items.forEach(item => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" class="itemCheckbox" value="${item}" checked> ${item}`;
    container.appendChild(label);

    label.querySelector('input').addEventListener('change', syncDesktopHeroSkillToMobile);
  });
}

/* ==========================================================
   select（手機） → checkbox（桌機）
========================================================== */
function populateSelect(id, items, preSelect = []) {
  const select = document.getElementById(id);
  select.innerHTML = '';
  items.forEach(item => {
    const op = document.createElement('option');
    op.value = item;
    op.textContent = item;
    if (preSelect.includes(item)) op.selected = true;
    select.appendChild(op);
  });

  if (id === 'laneSelect') select.addEventListener('change', syncMobileLaneToDesktop);
  if (id === 'heroSelect') select.addEventListener('change', syncMobileHeroToDesktop);
  if (id === 'skillSelect') select.addEventListener('change', syncMobileSkillToDesktop);
}

function getMobileSelected(id) {
  return Array.from(document.getElementById(id).selectedOptions).map(o => o.value);
}

function syncMobileLaneToDesktop() {
  const selected = getMobileSelected('laneSelect');
  const allSelect = document.getElementById('laneSelectAll');
  const laneCbs = document.querySelectorAll('#laneList .itemCheckbox');

  allSelect.checked = false;
  laneCbs.forEach(cb => cb.checked = false);

  if (selected.includes('全選')) {
    allSelect.checked = true;
    laneCbs.forEach(cb => cb.checked = true);
    showAllHeroes(); 
  } else {
    selected.forEach(l => {
      const cb = [...laneCbs].find(x => x.value === l);
      if (cb) cb.checked = true;
    });
  }

  syncDesktopHeroSkillToMobile();
}

function syncMobileHeroToDesktop() {
  const selected = getMobileSelected('heroSelect');
  document.querySelectorAll('#heroList .itemCheckbox')
    .forEach(cb => cb.checked = selected.includes(cb.value));
}

function syncMobileSkillToDesktop() {
  const selected = getMobileSelected('skillSelect');
  document.querySelectorAll('#skillList .itemCheckbox')
    .forEach(cb => cb.checked = selected.includes(cb.value));
}

/* ==========================================================
   checkbox（桌機） → select（手機）
========================================================== */
function syncDesktopLaneToMobile() {
  const select = document.getElementById('laneSelect');
  const allSelect = document.getElementById('laneSelectAll');
  const laneCbs = document.querySelectorAll('#laneList .itemCheckbox');

  const selected = [];

  if (allSelect.checked) selected.push('全選');
  else {
    laneCbs.forEach(cb => {
      if (cb.checked) selected.push(cb.value);
    });
  }

  [...select.options].forEach(op => {
    op.selected = selected.includes(op.value);
  });
}

function syncDesktopHeroSkillToMobile() {
  const heroSelect = document.getElementById('heroSelect');
  const heroCbs = document.querySelectorAll('#heroList .itemCheckbox');

  [...heroSelect.options].forEach(op => {
    op.selected = [...heroCbs].some(cb => cb.value === op.value && cb.checked);
  });

  const skillSelect = document.getElementById('skillSelect');
  const skillCbs = document.querySelectorAll('#skillList .itemCheckbox');

  [...skillSelect.options].forEach(op => {
    op.selected = [...skillCbs].some(cb => cb.value === op.value && cb.checked);
  });
}

/* ==========================================================
   功能：顯示所有英雄
========================================================== */
function showAllHeroes() {
  document.querySelectorAll('#heroList .itemCheckbox').forEach(cb => {
    cb.parentElement.style.display = 'flex';
    cb.checked = true;
  });
}

/* ==========================================================
   抽分路 → 再篩英雄
========================================================== */
function drawLane() {
  const selected = getMobileSelected('laneSelect')
    .filter(v => v !== '全選');

  if (selected.length === 0) {
    alert("⚠️ 請至少選一個分路！");
    return;
  }

  const lane = selected[Math.floor(Math.random() * selected.length)];
  document.getElementById('laneResult').textContent = lane;

  filterHeroesByLane([lane]);
}

/* ==========================================================
   分路 → 篩英雄
========================================================== */
function filterHeroesByLane(lanesSelected) {
  const heroCbs = document.querySelectorAll('#heroList .itemCheckbox');

  heroCbs.forEach(cb => {
    const hero = heroes.find(h => h.name === cb.value);
    const match = hero.lane.some(l => lanesSelected.includes(l));
    cb.parentElement.style.display = match ? 'flex' : 'none';
    cb.checked = match;
  });

  syncDesktopHeroSkillToMobile();
}

/* ==========================================================
   抽英雄
========================================================== */
function drawHero() {
  const visible = [...document.querySelectorAll('#heroList .itemCheckbox')]
    .filter(cb => cb.parentElement.style.display !== 'none')
    .map(cb => cb.value);

  if (visible.length === 0) {
    alert("⚠️ 無可抽英雄");
    return;
  }

  document.getElementById('heroResult').textContent =
    visible[Math.floor(Math.random() * visible.length)];
}

/* ==========================================================
   抽技能
========================================================== */
function drawSkill() {
  const selected = getMobileSelected('skillSelect');
  if (selected.length === 0) {
    alert("⚠️ 無技能可抽");
    return;
  }

  document.getElementById('skillResult').textContent =
    selected[Math.floor(Math.random() * selected.length)];
}

loadData();
</script>

</body>
</html>