<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AOV 隨機生成器</title>
<style>
body { font-family: "Microsoft JhengHei", sans-serif; background-color: #1b1b1b; color: #fff; text-align: center; padding: 20px; }
h1 { font-size: 2rem; margin-bottom: 20px; }
h2 { font-size: 1.5rem; margin: 20px 0 10px; }
button { background-color: #4CAF50; color: white; border: none; padding: 8px 16px; margin: 10px 0; border-radius: 6px; cursor: pointer; font-size: 1rem; }
button:hover { background-color: #45a049; }
button:disabled { background-color: #555; cursor: not-allowed; }
.result { margin-top: 10px; font-size: 1.2rem; background: #222; padding: 10px; border-radius: 8px; display: inline-block; }
.checkbox-list { display: flex; flex-wrap: wrap; justify-content: center; max-width: 600px; margin: 10px auto; background: #2a2a2a; padding: 8px; border-radius: 10px; }
label { margin: 4px 10px; display: flex; align-items: center; }
select { background: #2a2a2a; color: #fff; border: 1px solid #555; border-radius: 6px; padding: 6px; margin-top: 8px; min-width: 200px; }
@media (min-width: 768px) { select { display: none; } }
@media (max-width: 767px) { .checkbox-list { display: none; } }
</style>
</head>
<body>

<h1>AOV 隨機生成器</h1>

<!-- 分路 -->
<div class="section" id="laneSection">
  <h2>分路</h2>
  <div class="checkbox-list" id="laneList"></div>
  <select id="laneSelect" multiple></select><br>
  <button id="drawLaneBtn" onclick="drawLane()">隨機分路</button>
  <div class="result" id="laneResult">還沒抽取</div>
</div>

<!-- 英雄 -->
<div class="section" id="heroSection">
  <h2>英雄</h2>
  <div class="checkbox-list" id="heroList"></div>
  <select id="heroSelect" multiple></select><br>
  <button onclick="drawHero()">隨機英雄</button>
  <div class="result" id="heroResult">還沒抽取</div>
</div>

<!-- 技能 -->
<div class="section" id="skillSection">
  <h2>挑戰者技能</h2>
  <div class="checkbox-list" id="skillList"></div>
  <select id="skillSelect" multiple></select><br>
  <button onclick="drawSkill()">隨機技能</button>
  <div class="result" id="skillResult">還沒抽取</div>
</div>

<script>
let heroes=[], skills=[], lanes=[];

// 載入資料
async function loadData(){
  try{
    const response = await fetch('DB.json');
    const data = await response.json();
    heroes = data.heroes;
    skills = data.skills;

    const laneSet = new Set();
    heroes.forEach(h=>h.lane.forEach(l=>laneSet.add(l)));
    lanes = Array.from(laneSet);

    renderLaneCheckbox();
    renderCheckboxWithAll('hero', heroes.map(h=>h.name));
    renderCheckboxWithAll('skill', skills);

    populateSelect('laneSelect', ['全選', ...lanes, '全能'], ['全選']); // 手機端預設全選
    populateSelect('heroSelect', heroes.map(h=>h.name));
    populateSelect('skillSelect', skills);

    filterHeroesByLane(); // 初始化英雄列表
  } catch(err){
    console.error(err);
    alert("資料載入失敗");
  }
}

// 分路 checkbox
function renderLaneCheckbox(){
  const container=document.getElementById('laneList');
  container.innerHTML='';
  const drawBtn=document.getElementById('drawLaneBtn');

  // 全選
  const allLabel=document.createElement('label');
  allLabel.innerHTML=`<input type="checkbox" id="laneSelectAll" checked> 全選`;
  container.appendChild(allLabel);
  const selectAllCheckbox = allLabel.querySelector('input');
  selectAllCheckbox.addEventListener('change', function(){
    container.querySelectorAll('input.itemCheckbox').forEach(cb=>{ cb.checked=this.checked; cb.disabled=false; });
    document.getElementById('laneAllPower').checked=false;
    drawBtn.disabled=false;
    filterHeroesByLane();
  });

  // 普通分路
  lanes.forEach(lane=>{
    const label=document.createElement('label');
    label.innerHTML=`<input type="checkbox" class="itemCheckbox" value="${lane}" checked> ${lane}`;
    container.appendChild(label);
    label.querySelector('input').addEventListener('change', function(){
      if(document.getElementById('laneAllPower').checked) this.checked=false;
      selectAllCheckbox.checked=false;
      filterHeroesByLane();
    });
  });

  // 全能
  const allLabel2=document.createElement('label');
  allLabel2.innerHTML=`<input type="checkbox" id="laneAllPower"> 全能`;
  container.appendChild(allLabel2);
  const laneAllCheckbox=allLabel2.querySelector('input');
  laneAllCheckbox.addEventListener('change', function(){
    if(this.checked){
      container.querySelectorAll('input.itemCheckbox').forEach(cb=>{ cb.checked=false; cb.disabled=true; });
      selectAllCheckbox.checked=false;
      drawBtn.disabled=true;
      showAllHeroes();
    } else {
      container.querySelectorAll('input.itemCheckbox').forEach(cb=>cb.disabled=false);
      drawBtn.disabled=false;
      filterHeroesByLane();
    }
  });
}

// checkbox renderer
function renderCheckboxWithAll(type, items){
  const container=document.getElementById(type+'List');
  container.innerHTML='';
  items.forEach(item=>{
    const label=document.createElement('label');
    label.innerHTML=`<input type="checkbox" class="itemCheckbox" value="${item}" checked> ${item}`;
    container.appendChild(label);
  });
}

// select renderer
function populateSelect(selectId, items, preSelect=[]){
  const select=document.getElementById(selectId);
  select.innerHTML='';
  items.forEach(item=>{
    const option=document.createElement('option');
    option.value=item;
    option.textContent=item;
    if(preSelect.includes(item)) option.selected=true;
    select.appendChild(option);
  });

  // 手機端分路
  if(selectId==='laneSelect'){
    select.addEventListener('change', function(){
      const values = Array.from(this.selectedOptions).map(o=>o.value);
      const drawBtn=document.getElementById('drawLaneBtn');
      if(values.includes('全能')){
        drawBtn.disabled=true;
        showAllHeroes();
      } else {
        drawBtn.disabled=false;
        filterHeroesByLane(values.includes('全選') ? lanes : values);
      }
    });
  }
}

function getCheckedItems(type){
  if(window.innerWidth>=768){
    const items=Array.from(document.querySelectorAll(`#${type}List input.itemCheckbox:checked`)).map(cb=>cb.value);
    if(type==='lane'){
      if(document.querySelector('#laneAllPower').checked) items.push('全能');
      if(document.querySelector('#laneSelectAll').checked) items.push('全選');
    }
    return items;
  } else {
    const select=document.getElementById(type+'Select');
    return Array.from(select.selectedOptions).map(o=>o.value);
  }
}

function filterHeroesByLane(selectedLanes){
  selectedLanes = selectedLanes || getCheckedItems('lane');
  const heroContainer=document.getElementById('heroList');
  const heroCheckboxes=heroContainer.querySelectorAll('input.itemCheckbox');
  if(selectedLanes.includes('全能') || selectedLanes.includes('全選')){
    showAllHeroes(); return;
  }
  heroCheckboxes.forEach(cb=>{
    const heroData=heroes.find(h=>h.name===cb.value);
    if(heroData.lane.some(l=>selectedLanes.includes(l))){
      cb.parentElement.style.display='flex';
      cb.checked=true;
    } else {
      cb.parentElement.style.display='none';
      cb.checked=false;
    }
  });
}

function showAllHeroes(){
  const heroContainer=document.getElementById('heroList');
  heroContainer.querySelectorAll('input.itemCheckbox').forEach(cb=>{
    cb.parentElement.style.display='flex';
    cb.checked=true;
  });
}

function drawLane(){
  const selected=getCheckedItems('lane').filter(l=>l!=='全能' && l!=='全選');
  if(selected.length===0){ alert("⚠️ 請至少勾選一個分路！"); return; }
  const lane=getRandomItem(selected);
  document.getElementById('laneResult').textContent=lane;
  filterHeroesByLane([lane]);
}

function drawHero(){
  const selected=getCheckedItems('hero');
  if(selected.length===0){ alert("⚠️ 請至少勾選一個英雄！"); return; }
  document.getElementById('heroResult').textContent=getRandomItem(selected);
}

function drawSkill(){
  const selected=getCheckedItems('skill');
  if(selected.length===0){ alert("⚠️ 請至少勾選一個技能！"); return; }
  document.getElementById('skillResult').textContent=getRandomItem(selected);
}

function getRandomItem(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

loadData();
</script>
</body>
</html>